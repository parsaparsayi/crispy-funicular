import os
from flask import Flask, request, jsonify, send_from_directory, render_template
from werkzeug.exceptions import HTTPException
import grok  # uses your existing pipeline functions

app = Flask(__name__)
app.secret_key = "dev"  # local use only

# Always use the same OUTPUT_DIR as grok.py
OUTPUT_DIR = grok.OUTPUT_DIR
os.makedirs(OUTPUT_DIR, exist_ok=True)

def _list_videos():
    if not os.path.isdir(OUTPUT_DIR):
        return []
    files = [f for f in os.listdir(OUTPUT_DIR) if f.lower().endswith(".mp4")]
    files.sort(key=lambda name: os.path.getmtime(os.path.join(OUTPUT_DIR, name)), reverse=True)
    return files

@app.errorhandler(Exception)
def _json_errors(e):
    # Ensure every unexpected error returns JSON (not HTML), so the front-end can show a helpful message
    code = 500
    if isinstance(e, HTTPException):
        code = e.code
    return jsonify(ok=False, error=e.__class__.__name__, detail=str(e)), code

@app.route("/")
def index():
    defaults = {
        "image_url": getattr(grok, "DEFAULT_IMAGE_URL", os.getenv("DEFAULT_IMAGE_URL", "")),
        "audio_url": getattr(grok, "DEFAULT_AUDIO_URL", os.getenv("DEFAULT_AUDIO_URL", "")),
        "output_dir": OUTPUT_DIR,
    }
    return render_template("index.html", defaults=defaults, videos=_list_videos())

@app.route("/media/<path:filename>")
def media(filename):
    return send_from_directory(OUTPUT_DIR, filename)

@app.post("/tts")
def tts():
    data = request.get_json(force=True, silent=True) or {}
    text = (data.get("text") or "").strip()
    upload = bool(data.get("upload", True))
    if not text:
        return jsonify(ok=False, error="BadRequest", detail="Text is empty"), 400

    voice_id = grok.load_voice_id()
    if not voice_id:
        return jsonify(ok=False, error="NoVoiceId", detail="Put voice_id.txt next to grok.py or run CLI Option 6"), 400

    try:
        mp3_path = grok.generate_tts(voice_id, text)
    except Exception as e:
        return jsonify(ok=False, error="TTSException", detail=str(e)), 500

    if not mp3_path:
        return jsonify(ok=False, error="TTSFailed", detail="generate_tts returned None"), 500

    url = None
    if upload:
        try:
            url = grok.upload_output_mp3_and_set_default()
        except Exception as e:
            # Do not fail the whole request just because upload failed
            url = None
    return jsonify(ok=True, mp3=mp3_path, uploaded_url=url)

@app.post("/animate")
def animate():
    data = request.get_json(force=True, silent=True) or {}
    image_url = (data.get("image_url") or "").strip() or getattr(grok, "DEFAULT_IMAGE_URL", os.getenv("DEFAULT_IMAGE_URL", ""))
    # If audio_url == "", grok.animate_avatar_did will force local output.mp3 / FFmpeg fallback
    audio_url = (data.get("audio_url") or "").strip()
    try:
        result = grok.animate_avatar_did(image_url, audio_url)
    except Exception as e:
        return jsonify(ok=False, error="AnimateException", detail=str(e)), 500

    ok = bool(result)
    basename = None
    if ok and isinstance(result, str) and os.path.exists(result):
        basename = os.path.basename(result)
    return jsonify(ok=ok, result=result, basename=basename)

@app.post("/full")
def full():
    data = request.get_json(force=True, silent=True) or {}
    question = (data.get("question") or "").strip()
    upload = bool(data.get("upload", True))
    image_url = (data.get("image_url") or "").strip() or getattr(grok, "DEFAULT_IMAGE_URL", os.getenv("DEFAULT_IMAGE_URL", ""))

    if not question:
        return jsonify(ok=False, error="BadRequest", detail="Question is empty"), 400

    # Persona answer
    try:
        answer = grok.chat_like_me(question)
    except Exception as e:
        return jsonify(ok=False, error="GroqException", detail=str(e)), 500
    if not answer:
        return jsonify(ok=False, error="NoAnswer", detail="No answer from chat_like_me"), 500

    # TTS
    voice_id = grok.load_voice_id()
    if not voice_id:
        return jsonify(ok=False, error="NoVoiceId", detail="Put voice_id.txt next to grok.py or run CLI Option 6"), 400
    try:
        mp3_path = grok.generate_tts(voice_id, answer)
    except Exception as e:
        return jsonify(ok=False, error="TTSException", detail=str(e)), 500
    if not mp3_path:
        return jsonify(ok=False, error="TTSFailed", detail="generate_tts returned None"), 500

    # Optional upload (sets grok.DEFAULT_AUDIO_URL if successful)
    audio_url = ""
    if upload:
        try:
            grok.upload_output_mp3_and_set_default()
            audio_url = getattr(grok, "DEFAULT_AUDIO_URL", os.getenv("DEFAULT_AUDIO_URL", ""))
        except Exception as e:
            # Keep going without upload
            audio_url = ""

    # Animate
    try:
        video_result = grok.animate_avatar_did(image_url, audio_url)
    except Exception as e:
        return jsonify(ok=False, error="AnimateException", detail=str(e)), 500

    basename = os.path.basename(video_result) if (isinstance(video_result, str) and os.path.exists(video_result)) else None

    return jsonify(ok=bool(video_result), question=question, answer=answer,
                   mp3=mp3_path, result=video_result, basename=basename)

if __name__ == "__main__":
    app.run(debug=True)





